# 日志系统使用

## 概述

实现了统一的日志系统，用于替代原有的 `print` 语句，提供灵活的日志级别控制和输出格式配置。

## 日志级别

支持以下日志级别（从低到高）：

1. **TRACE** (5) - 最详细的跟踪信息，用于深度调试
2. **DEBUG** (10) - 调试信息，开发时使用
3. **INFO** (20) - 一般信息，默认显示（默认级别）
4. **WARNING** (30) - 警告信息，需要注意但不影响正常运行
5. **ERROR** (40) - 错误信息，出现问题但程序可以继续
6. **CRITICAL** (50) - 关键错误，可能导致程序无法继续

## 配置方式

### 1. 环境变量配置

设置环境变量 `AVDAG_LOG_LEVEL` 来控制日志级别：

```bash
export AVDAG_LOG_LEVEL=DEBUG
python your_script.py
```

### 2. 代码配置

在代码中直接配置：

```python
from avdag.logger import configure_logging, set_log_level

# 方式1：完整配置
configure_logging(
    level="DEBUG",          # 日志级别
    use_colors=True,        # 使用颜色输出
    show_time=True,         # 显示时间
    show_module=True,       # 显示模块名
    output_file="debug.log" # 输出到文件（可选）
)

# 方式2：仅设置级别
set_log_level("DEBUG")
```

### 3. 配置文件

创建 `logging_config.json` 文件：

```json
{
  "level": "DEBUG",
  "use_colors": true,
  "show_time": true,
  "show_module": true,
  "output_file": "logs/debug.log"
}
```

然后在代码中加载：

```python
from avdag.logger import configure_logging

configure_logging(config_file="logging_config.json")
```

或者通过环境变量指定配置文件：

```bash
export AVDAG_LOG_CONFIG=logging_config.json
python your_script.py
```

## 使用方式

### 基本使用

```python
from avdag.logger import get_logger

logger = get_logger(__name__)

logger.trace("最详细的跟踪信息")
logger.debug("调试信息")
logger.info("一般信息") 
logger.warning("警告信息")
logger.error("错误信息")
logger.critical("关键错误")
```

### 预定义日志器

项目提供了一些预定义的日志器：

```python
from avdag.logger import (
    get_verifier_logger,    # 验证器日志
    get_ocr_logger,         # OCR处理日志
    get_llm_logger,         # LLM调用日志
    get_frame_logger,       # 帧处理日志
    get_condition_logger    # 条件检查日志
)

verifier_logger = get_verifier_logger()
verifier_logger.info("验证开始")

ocr_logger = get_ocr_logger() 
ocr_logger.debug("OCR识别中...")
```

### 兼容性函数

为了与现有代码兼容，提供了一些便捷函数：

```python
from avdag.logger import debug_print, info_print, error_print, warning_print

debug_print("这是调试信息", "VERIFIER")
info_print("这是一般信息", "OCR")
error_print("这是错误信息", "LLM")
warning_print("这是警告信息", "FRAME")
```

## 输出格式

### 控制台输出（带颜色）

```
14:30:25 [INFO] avdag.verifier 验证任务开始
14:30:25 [DEBUG] avdag.frame 节点 search_box: 找到 2 个候选帧 [1, 3]
14:30:26 [ERROR] avdag.ocr PaddleOCR识别失败: 模型文件不存在
14:30:26 [WARNING] avdag.llm LLM调用超时，使用备用策略
```

### 文件输出

```
2024-08-17 14:30:25 [INFO] avdag.verifier 验证任务开始
2024-08-17 14:30:25 [DEBUG] avdag.frame 节点 search_box: 找到 2 个候选帧 [1, 3]
2024-08-17 14:30:26 [ERROR] avdag.ocr PaddleOCR识别失败: 模型文件不存在
2024-08-17 14:30:26 [WARNING] avdag.llm LLM调用超时，使用备用策略
```

## 实际应用示例

### 开发阶段

```bash
# 显示所有调试信息
export AVDAG_LOG_LEVEL=DEBUG
python -m avdag.verifier examples/tasks/shop_search.yaml examples/traces/sample_shop_trace.json
```

### 生产环境

```bash
# 只显示重要信息和错误
export AVDAG_LOG_LEVEL=WARNING
python your_production_script.py
```

### 问题调试

```bash
# 最详细的跟踪信息，输出到文件
export AVDAG_LOG_LEVEL=TRACE
python your_script.py 2>&1 | tee debug.log
```

或者在代码中：

```python
from avdag.logger import configure_logging

configure_logging(
    level="TRACE",
    output_file="debug.log",
    show_time=True,
    show_module=True
)
```

### OCR调试

```bash
# 专门调试OCR问题
export AVDAG_LOG_LEVEL=DEBUG
python examples/run_taobao_verify.py
```

### LLM调用调试

```python
from avdag.logger import get_llm_logger, set_log_level

set_log_level("DEBUG")
llm_logger = get_llm_logger()

# 在LLM调用前后记录详细信息
llm_logger.debug(f"准备调用LLM，prompt长度: {len(prompt)}")
result = llm_call(prompt)
llm_logger.debug(f"LLM返回结果: {result}")
```

## 最佳实践

1. **模块化日志器**：每个模块使用独立的日志器
   ```python
   logger = get_logger(__name__)
   ```

2. **合适的日志级别**：
   - `TRACE`: 最详细的执行流程
   - `DEBUG`: 中间变量值、状态变化
   - `INFO`: 重要的业务逻辑节点
   - `WARNING`: 异常情况但不影响继续执行
   - `ERROR`: 错误情况
   - `CRITICAL`: 严重错误

3. **性能考虑**：使用级别检查避免不必要的字符串格式化
   ```python
   if logger.is_enabled_for("DEBUG"):
       logger.debug(f"复杂的调试信息: {expensive_operation()}")
   ```

4. **结构化日志**：使用一致的格式便于分析
   ```python
   logger.info(f"任务 {task_id} 完成，耗时 {duration:.2f}s，成功率 {success_rate:.1%}")
   ```

## 迁移指南

原有的 `print` 语句已经自动替换为相应的日志调用：

- `print(f"[OCR] ...")` → `ocr_logger.info(...)`
- `print(f"[Frame Search] ...")` → `frame_logger.debug(...)`
- `print(f"[LLM] ...")` → `llm_logger.debug(...)`
- `print(f"DEBUG: ...")` → `verifier_logger.debug(...)`

如果需要自定义日志行为，可以根据需要调整日志级别和格式。
