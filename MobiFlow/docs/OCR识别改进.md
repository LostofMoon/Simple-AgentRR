# 增强版OCR识别辅助

把“识别不稳定导致漏匹配”的链路补强：

实现多引擎+多预处理+滑窗补充+文本多视图匹配，并把 OCR 与 XML 文本融合，外加缓存与排序稳定化，尽量消除漏报与波动。

## 目标清单
- 提高识别召回，尽可能覆盖图中真实文字元素。
- 降低多次识别结果不一致的波动。
- 匹配阶段更稳健，减少因轻微噪声/断词/空格导致的漏判。
- 在 OCR 失败时自动回落到 XML 文本。

## 已做改进（核心方案）
- 多引擎联合识别
  - 同时准备 PaddleOCR 与 Tesseract，两套引擎都跑，合并结果（引擎差异互补）。
- 多预处理变体
  - 对同一图像生成多种视图：原图、放大1.5x/2.0x、灰度、锐化、增强对比度、二值化；对每个视图分别做 OCR 并合并。
- 轻量滑窗补充
  - 若全局结果词数偏少，自动启用2×2重叠的滑窗裁剪识别，补充小字或局部区域漏识别。
- 文本标准化与多视图匹配
  - 统一全角转半角、大小写折叠、常见易混字符归一（O/0、l/I/1、S/5、B/8、中文竖线等）。
  - 生成多视图：cleaned（清洗）、no_spaces（去空格）、words（分词）、chars（逐字序列），并支持：
    - 连续（no_spaces）匹配
    - 子词包含匹配
    - 中文逐字按序匹配
    - RapidFuzz 部分相似度匹配（可选，80分阈值）
- OCR + XML 融合、逐级降级
  - 若图像不可用或 OCR 为空，则提取 XML 文本（text/content-desc/hint + 资源 ID 可读化）。
  - 在 frame 层合并 OCR 与 XML 两侧结果用于匹配，尽量不丢任何候选文本。
- 结果缓存与稳定排序
  - 基于“路径+mtime+size”的键缓存识别的词列表，多次调用返回稳定集合。
  - 最终词集合按字典序稳定排序，减少“总词数不一致”的波动。
- 运行日志更可诊断
  - 打印合并前后词数、样例片段，便于定位具体漏项。

## 关键文件改动
- ocr_processor.py
  - 新增：多引擎、多预处理、滑窗补充、文本标准化与智能匹配逻辑、缓存。
  - create_frame_ocr_function / create_frame_texts_function 现会融合 XML 与 OCR 的文本，并把多视图结果回填进 frame（_ocr_processed/_xml_processed）。
  - 提供智能匹配 smart_text_contains，支持空格/断词鲁棒与模糊匹配。
- 条件器无需改动即可使用，因为 OCRMatch 已读取 frame 的处理结果并做智能匹配；我保留了兼容路径并输出调试信息。

## 如何使用
- 标准用法保持不变：通过 create_standard_ocr_functions() 注入 OCR。


## 效果
- 召回：多引擎+多预处理+滑窗让原先“有字但没识别”的情况显著减少。
- 稳定：缓存+稳定排序消除多次调用总词数波动。
- 匹配：无空格/分词/逐字/模糊等多策略配合，显著降低因 OCR 断词、空格、轻微错字导致的漏报。

## 质量门（快速）
- 语法/运行：已执行增强匹配小测，所有断言通过。
- 依赖：Pillow 已在工程中使用；RapidFuzz 属可选（缺失时自动降级到基础匹配）。

## 后续可选增强
- 利用 XML 坐标/控件层级对感兴趣区域做 ROI 识别（更精确的滑窗，成本更低）。
- 小模型语言归一（中英文数词混排的词典纠错）。
- 引入得分投票：多引擎/多视图为每个词累积分数，匹配时按词频/置信度加权。
- 参数开关：通过环境变量控制滑窗启用阈值与模糊匹配阈值，便于性能—召回折中。

## 变更
- “尽可能确保图中有的文字元素可匹配”：Done（多引擎、多预处理、滑窗、融合）。
- “降低多次识别结果不一致”：Done（缓存+稳定排序）。
- “匹配更鲁棒、避免漏报”：Done（标准化+多策略匹配+XML回退/融合）。

## 使用时的注意事项

当前的页面关键词OCR辅助识别，已经具备页面内元素识别的较高准确性。但由于页面的排版设计、元素UI样式各异等因素，例如对于“我的淘宝”，“马上抢红包”等关键词，不一定保证识别结果是联系的短句，如果采用 


![alt text](./images/识别示例.png)

识别结果可能为：
```
y999 400 m0u mnes 8er ease dem ee5 a 00 d0 视频 消息 购物 车 我 的 三 e g6 eg 一 5u0men 淘
```
因此，匹配时选取**针对词语**的组合，如
```
all:["我的","淘宝"]
all:[“马上","抢","红包”]
```
等拆分模式匹配，能够显著提高匹配成功率。
